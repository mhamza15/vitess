# Adds a review checklist comment to newly opened pull requests. Skips PRs with 
# "Backport" or "Forwardport" labels since those are automated.
name: PR review checklist
on:
  pull_request_target:
    types: [opened]

permissions:
  pull-requests: write
  contents: read

jobs:
  add_review_checklist:
    name: Add review checklist
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.base_ref }}
          persist-credentials: 'false'

      - name: Check for "Backport" or "Forwardport" labels
        id: check_labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get labels for this pull request
          LABELS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels --jq '.[].name')

          # Check if PR has "Backport" or "Forwardport" label
          if echo "$LABELS" | grep -qi "^backport$\|^forwardport$"; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "PR has \"Backport\" or \"Forwardport\" label, skipping review checklist"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Add Review Checklist Comment
        if: steps.check_labels.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body-file .github/review_checklist.md
